<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>跳转中…</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0 auto;max-width:720px;padding:24px;text-align:center;line-height:1.6}
  h2{margin:6px 0 4px}
  .btn,a.btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fafafa;text-decoration:none;display:inline-block;margin:6px;cursor:pointer}
  code{background:#f6f8fa;padding:4px 6px;border-radius:6px;word-break:break-all}
  img{max-width:100%}
  #panel{display:none;margin-top:10px}
  small{color:#666}
</style>
</head>
<body>
  <h2 id="title">正在尝试打开目标…</h2>
  <p id="desc">请稍候。</p>

  <div id="panel">
    <div id="actionArea"></div>
    <p>或长按识别二维码：</p>
    <div id="qrcode"></div>
    <p>目标：<code id="urlBox"></code></p>
    <p><small>提示：在微信内，第三方 App 的自定义 URL Scheme 往往会被限制；若无法唤起，请使用右上角“在浏览器打开”。</small></p>
  </div>

<script>
const qs = new URLSearchParams(location.search);
const target = qs.get('t') ? decodeURIComponent(qs.get('t')) : null;

const isWeChat = /MicroMessenger/i.test(navigator.userAgent);
const isHttpLike = (u) => /^https?:\/\//i.test(u);
const isScheme = (u) => /^[a-z][a-z0-9+\-.]*:\/\//i.test(u) && !isHttpLike(u);

const title = document.getElementById('title');
const desc  = document.getElementById('desc');
const panel = document.getElementById('panel');
const box   = document.getElementById('urlBox');
const qrcode= document.getElementById('qrcode');
const actions= document.getElementById('actionArea');

if(!target){
  title.textContent = '未指定跳转目标';
  desc.textContent  = '缺少参数 t。';
} else {
  box.textContent = target;
  qrcode.innerHTML = `<img alt="QR" width="220" height="220"
      src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(target)}">`;

  // 构建按钮区
  const openBtn = document.createElement('a');
  openBtn.className = 'btn';
  openBtn.textContent = isHttpLike(target) ? '在浏览器中打开' : '尝试唤起应用';
  openBtn.href = isHttpLike(target) ? target : 'javascript:void(0)';
  openBtn.rel = 'noopener noreferrer';
  openBtn.target = '_blank';

  // 复制
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn';
  copyBtn.textContent = '复制链接';
  copyBtn.onclick = async () => {
    try { await navigator.clipboard.writeText(target); copyBtn.textContent = '已复制'; setTimeout(()=>copyBtn.textContent='复制链接',1200); }
    catch { alert('复制失败，请手动长按复制'); }
  };

  actions.appendChild(openBtn);
  actions.appendChild(copyBtn);
  panel.style.display = 'block';

  const tryOpenScheme = () => {
    // 仅对自定义 scheme 进行尝试（如 alipays://、myapp://）
    if (!isScheme(target)) return;

    // 必须在用户手势下更稳妥，这里也做一次自动尝试 + 降级
    const start = Date.now();
    let jumped = false;

    const done = () => {
      if (jumped) return;
      jumped = true;
      title.textContent = '如未成功，请使用下面的方式';
      desc.textContent = isWeChat
        ? '微信可能拦截了对外部 App 的唤起，请点击“在浏览器中打开”或复制链接后外部打开。'
        : '未检测到已安装应用或系统阻止了唤起，请手动操作。';
    };

    // 自动尝试（部分环境会立即被拦截，不影响页面）
    try {
      // 直接赋值更通用；iframe 在一些版本同样会被拦截
      window.location.href = target;
    } catch(e){}

    // 定时降级
    setTimeout(done, 1500);

    // 同时把“尝试唤起应用”按钮绑定为用户手势再试一次
    openBtn.onclick = () => {
      try { window.location.href = target; } catch(e){}
      setTimeout(done, 1200);
    };
  };

  if (isWeChat) {
    if (isScheme(target)) {
      title.textContent = '尝试唤起应用…';
      desc.textContent  = '如出现系统提示，请按需选择；若无反应，请用下方方式处理。';
      // 在微信内：多数自定义 scheme 会被限制，这里仍做一次尝试并给出降级
      tryOpenScheme();
    } else if (isHttpLike(target)) {
      title.textContent = '请在浏览器中打开';
      desc.textContent  = '点击下方按钮，或用右上角“··· → 在浏览器打开”。';
      // 尝试调用 WeixinJSBridge 打开外部浏览器（需用户手势，且可能受限）
      openBtn.onclick = () => {
        if (typeof WeixinJSBridge !== 'undefined') {
          WeixinJSBridge.invoke('openUrlByExtBrowser', { url: target }, function(){});
        } else {
          // 备用：仍旧用 _blank 打开，或提示右上角操作
          window.open(target, '_blank', 'noopener');
        }
      };
    }
  } else {
    // 非微信环境
    if (isScheme(target)) {
      title.textContent = '尝试唤起应用…';
      desc.textContent  = '';
      tryOpenScheme();
    } else {
      title.textContent = '即将跳转';
      desc.textContent  = '如未自动跳转，请使用下方按钮。';
      setTimeout(()=>{ location.href = target; }, 500);
    }
  }
}
</script>
</body>
</html>
