<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>跳转中…</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; padding: 24px; max-width: 720px; margin: auto; text-align:center; line-height:1.6; }
  h2 { margin-top: 8px; }
  .btn, a.btn { padding:10px 14px; margin:6px; border:1px solid #ddd; border-radius:10px; background:#fafafa; text-decoration:none; display:inline-block; cursor:pointer; }
  .btn:active, a.btn:active { transform: translateY(1px); }
  code { background:#f6f8fa; padding:4px 6px; border-radius:6px; word-break:break-all; }
  #panel { display:none; margin-top: 12px; }
  small{color:#666}
  img { max-width: 100%; }
</style>
</head>
<body>

<h2 id="title">正在准备跳转…</h2>
<p id="desc">请稍候。</p>

<div id="panel">
  <p>如果未自动跳转，请手动操作：</p>
  <div>
    <a id="openBtn" class="btn" rel="noopener noreferrer" target="_blank">在浏览器中打开</a>
    <button id="copyBtn" class="btn">复制链接</button>
  </div>
  <p>或长按识别二维码：</p>
  <div id="qrcode"></div>
  <p>目标：<code id="urlBox"></code></p>
  <p><small>提示：在微信中，下载类文件（如 .apk/.pdf/.zip 等）更可能触发“在浏览器打开”的提示；普通网页通常不会。</small></p>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const target = qs.get('t') ? decodeURIComponent(qs.get('t')) : null;

  const title = document.getElementById('title');
  const desc  = document.getElementById('desc');
  const panel = document.getElementById('panel');
  const openBtn = document.getElementById('openBtn');
  const copyBtn = document.getElementById('copyBtn');
  const urlBox  = document.getElementById('urlBox');
  const qrcode  = document.getElementById('qrcode');

  if(!target){
    title.textContent = '未指定跳转目标';
    desc.textContent  = '缺少参数 t。';
  } else {
    urlBox.textContent = target;
    openBtn.href = target;

    // 生成二维码（无需第三方库）
    qrcode.innerHTML = `<img alt="QR" width="220" height="220"
      src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(target)}">`;

    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(target);
        copyBtn.textContent = '已复制';
        setTimeout(()=>copyBtn.textContent='复制链接', 1500);
      } catch {
        alert('复制失败，请手动长按复制');
      }
    };

    const isWeChat = /MicroMessenger/i.test(navigator.userAgent);

    // 仅当“看起来像下载类文件”时，尝试用 <a download> 触发
    // （不做任何伪装；只是如果目标确为这些类型，再去尝试）
    let tryDownload = false;
    try {
      const u = new URL(target);
      const path = u.pathname.toLowerCase();
      tryDownload = /\.(apk|ipa|zip|rar|7z|pdf|docx?|xlsx?|pptx?|dmg|pkg|msi|exe|tar|gz|bz2|xz)$/.test(path);
    } catch { /* ignore URL parse errors */ }

    if (isWeChat && tryDownload) {
      title.textContent = '尝试触发下载…';
      desc.textContent  = '如出现“在浏览器打开”提示，请选择允许。';

      const a = document.createElement('a');
      a.href = target;
      a.setAttribute('download', '');
      document.body.appendChild(a);
      a.click();
      a.remove();

      // 无论系统是否弹窗，都在短暂等待后展示备用面板
      setTimeout(() => {
        title.textContent = '如未弹出提示，请手动操作';
        desc.textContent  = '';
        panel.style.display = 'block';
      }, 1500);
    } else if (isWeChat && !tryDownload) {
      // 微信 + 非下载类：不做 download 尝试，直接给备用面板
      title.textContent = '请在浏览器中打开';
      desc.textContent  = '当前链接不是下载类资源，微信通常不会弹出提示。';
      panel.style.display = 'block';
    } else {
      // 非微信：直接跳
      title.textContent = '即将跳转';
      desc.textContent  = '如未自动跳转，请使用下方按钮。';
      panel.style.display = 'block';
      setTimeout(() => { location.href = target; }, 500);
    }
  }
</script>
</body>
</html>
